# ranked_doda


Install:
```
apt install pipx
pipx install poetry
```


# Алгоритм вычисления мэмра

1. По умолчанию у всех 500
2. Перед боем считаем `th_skew`. По сути это шанс победы Radiant
```
1. Считаем для каждого игрока его теоретический импакт player_th_impact = player_rating * (-0.25 * (pos - 1) + 2)
Идея в том, что игрок на первой позиции решает больше всего (его рейтинг умножается на 2), а на пятой меньше всего (его рейт умножается на 1)
th_skew_radiant = сумме всех player_th_impact его союзников
th_skew = th_skew_radiant / th_skew_dire
```
3. Когда бой уже произошел считаем `pr_skew`. Это число того, насколько Radiant команда сильно доминировала в игре. 
```
pr_skew = (radiant_kills / dire_kills) ** (1.5 часа / duration)

Идея в том, что разницу по килам мы "усиливаем" разницей во времени.
Если килов одинаково, то игра в целом была равной.

Если килов было больше у radiant, то pr_skew > 1.

Чем дольше длился матч, тем меньше влияет разница по килам.
Кем короче матч, тем больше pr_skew будет от идеальной "единицы"
```
4. Расчитываем пул очков которые мы будем давать radiant и dire.
```
disbalance = (max(th_skew, r.pr_skew) / min(th_skew, r.pr_skew)) ** 0.3
pool = 50 * disbalance

степень 0.3 тут для "смягчения эффекта", чтобы если дизбаланс был, например, 6, не надо было разыгрывать 50*6 = 300 очков
чем выше степень, тем больше импакт одиночной игры 
```
5. Победители делят пул очков в соответствии со своим импактом (колонка `carried`)
6. У проигравших отнимаются очки в соответствии с их руиной (колонка `ruined`)
7. Для матчмейкинга надо подбирать команды так, чтобы `th_skew ~= 1`


# Пример
```
+-------------------+----+-------+-------+----+---+----------+---+---------+--------+------+-------+----------+-----+
|              match|team|th_skew|pr_skew|pool|  r|  username|pos|net_worth|     kda|ruined|carried|       mmr|delta|
+-------------------+----+-------+-------+----+---+----------+---+---------+--------+------+-------+----------+-----+
|2023-10-07 22:21:00| DIR|    48%|   341%|  89|  L|         p|  3|    11816|   5/6/6|   10%|    19%|507 -> 497|   -9|
|2023-10-07 22:21:00| DIR|    48%|   341%|  89|  L| tayviscon|  5|     8727|  4/8/13|   14%|    25%|514 -> 501|  -12|
|2023-10-07 22:21:00| DIR|    48%|   341%|  89|  L|      imba|  1|    15022|  5/6/11|    7%|    20%|514 -> 507|   -7|
|2023-10-07 22:21:00| DIR|    48%|   341%|  89|  L|angry_duck|  4|     6778| 0/12/10|   51%|    13%|511 -> 465|  -46|
|2023-10-07 22:21:00| DIR|    48%|   341%|  89|  L|   katokan|  2|    13819| 5/11/12|   15%|    20%|529 -> 515|  -14|
|2023-10-07 22:21:00| RAD|    48%|   341%|  89|  W|    runner|  2|    16961| 13/5/13|   21%|    19%|519 -> 536|  +17|
|2023-10-07 22:21:00| RAD|    48%|   341%|  89|  W|   sobolew|  1|    21562|  8/3/10|   14%|    14%|498 -> 511|  +12|
|2023-10-07 22:21:00| RAD|    48%|   341%|  89|  W|     pizza|  5|    12416|  5/5/22|   30%|    19%|467 -> 484|  +17|
|2023-10-07 22:21:00| RAD|    48%|   341%|  89|  W| fishscale|  4|    11669|  9/1/22|    4%|    30%|492 -> 520|  +27|
|2023-10-07 22:21:00| RAD|    48%|   341%|  89|  W| starlight|  3|    18197|  8/6/16|   28%|    16%|508 -> 524|  +15|
```

Посмотрим на ММР команд до начала матча:
```
Dire 507, 514, 514, 511, 529
Radiant 519, 498, 467, 492, 508
```
В целом они +- одинаковы, поэтому `th_skew = 48%`. Шанс победы Radiant был +- 50% в теории.

После катки мы видим, что была **однокалиточная** в сторону Radiant `pr_skew=341%`

Значит нам надо "раздать" побольше пул, чтобы компенсировать большую разницу уровня игроков, больше дефолтных 50. 
`pool=89`

Из Radiant наибольший импакт внёс fishscale. По счёту `9/1/22` и его нетворсу был посчитан `carried = 30%`. 
Он получает самую большую награду `pool * carried = 89 * 30% = +27`

Из Dire заруинил больше всего angry_duck. По счёту `0/12/10` и нетворсу был посчитан `ruined = 51%`.
Он получает самый жирный минус `pool * ruined = 89 * 51% = -46`
